image: python:3.10-bullseye

stages:
  - validate
  - test
  - build
  - deploy
  - cleanup

variables:
  TF_VERSION: "1.4.6"
  TF_STATE_NAME: "default"
  TF_CACHE_KEY: "default"

before_script:
  - pip install flake8 pytest pytest-cov
  - pip install -r requirements.txt

run_tests:
  stage: test
  script:
    - pytest -v --cov

validate:
  stage: validate
  script:
    - terraform init
    - terraform validate

fmt:
  stage: validate
  script:
    - terraform fmt -check

build:
  stage: build
  script:
    - terraform init
    - terraform plan

deploy:
  stage: deploy
  script:
    - terraform apply -auto-approve

cleanup:
  stage: cleanup
  script:
    - terraform destroy -auto-approve
